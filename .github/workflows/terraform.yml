name: Terraform On-Prem Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  terraform:
    name: Terraform On-Prem Pipeline
    runs-on: ubuntu-latest

    env:
      TF_IN_AUTOMATION: true
      TF_INPUT: false

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.9.0

      # Format check
      - name: Terraform fmt
        run: terraform fmt -check

      # Initialize Terraform (local backend for on-prem)
      - name: Terraform Init
        run: terraform init

      # Validate Terraform code
      - name: Terraform Validate
        run: terraform validate

      # Terraform Plan
      - name: Terraform Plan
        id: plan
        run: terraform plan -out=tfplan

      # Upload plan as artifact
      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: tfplan

  apply:
    name: Terraform Apply (Manual)
    needs: terraform
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.9.0

      - name: Download plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        
      - name: Simple deploy to Kubernetes cluster
        # You may pin to the exact commit or the version.
        # uses: Jtalk/k8s-deploy@dbd56d528215e63ec2a51d1037c2f2796d5e1967
        uses: Jtalk/k8s-deploy@v2
        with:
        # Choose the target Kubernetes namespace. If the namespace is not provided, the commands will run in the default namespace.
          namespace: # optional
        # Path to the manifest files which will be used for deployment.
          manifests: # default is 
        # Fully qualified resource URL of the image(s) to be used for substitutions on the manifest files Example: contosodemo.azurecr.io/helloworld:test
          images: # optional
          # Name of a docker-registry secret that has already been set up within the cluster. Each of these secret names are added under imagePullSecrets field for the workloads found in the input manifest files
          imagepullsecrets: # optional
          # Version of kubectl. Installs a specific version of kubectl binary
          kubectl-version: # optional
          # Deployment strategy to be used. Allowed values are none, canary
          strategy: # optional, default is none
          # Traffic split method to be used. Allowed values are pod, smi
          traffic-split-method: # optional, default is pod
          # Baseline and canary replicas count; valid value i.e between 0 to 100.
          baseline-and-canary-replicas: # optional, default is 0
          # Percentage of traffic redirect to canary deployment
          percentage: # optional, default is 0
          # Arguments
          args: # optional
          # deploy/promote/reject
          action: # default is deploy
          
